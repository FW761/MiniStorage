{% extends 'main/base_templat.html' %}

{% block content %}
    <div id="menu-div">
        <div class="basic-div">
            <ul id="main-menu-bar">
                <li class="main-menu-list-element">
                <span class="menu-item">
                    {% if user.first_name or user.last_name %}
                        {{ user.get_full_name }}
                    {% else %}
                        {{ user }}
                    {% endif %}
                </span>
                    <ul class="drop-down-menu">
                        <li class="drop-down-menu-list-element">
                        <span class="menu-item">
                            <a class="menu-link" href="{% url 'logout' %}">Выйти</a>
                        </span>
                        </li>
                    </ul>
                </li>
                <li class="main-menu-list-element">
                    <span class="menu-item">Справочники</span>
                    <ul class="drop-down-menu">
                        <li class="dropDownMenuListElement">
                            <span class="menu-item" id="show-products-button">Товары</span>
                        </li>
                        <li class="drop-down-menu-list-element">
                            <span class="menu-item">Контрагенты</span>
                        </li>
                    </ul>
                </li>
                <li class="main-menu-list-element">
                    <span class="menu-item">Документы</span>
                    <ul class="drop-down-menu">
                        <li class="dropDownMenuListElement">
                            <span class="menu-item">Приходные документы</span>
                        </li>
                        <li class="dropDownMenuListElement">
                            <span class="menu-item">Расходные документы</span>
                        </li>
                    </ul>
                </li>
                <li class="main-menu-list-element">
                    <span class="menu-item">Отчеты</span>
                    <ul class="drop-down-menu">
                        <li class="dropDownMenuListElement">
                            <span class="menu-item">Остатки товаров на складе</span>
                        </li>
                        <li class="dropDownMenuListElement">
                            <span class="menu-item">Движение в разрезе товаров</span>
                        </li>
                        <li class="dropDownMenuListElement">
                            <span class="menu-item">Движение в разрезе контрагентов</span>
                        </li>
                    </ul>
                </li>
                <li class="main-menu-list-element">
                <span class="menu-item">
                    <a class="menu-link" href="/admin/">Администрирование</a>
                </span>
                </li>
            </ul>
        </div>
    </div>

    <div class="content-div" id="content-div" style="display: none"></div>

    <script>
        let showProductsButton = document.getElementById("show-products-button");
        showProductsButton.addEventListener("click", event => {
            event.stopPropagation();
            let userToken = localStorage.getItem("user_token");
            let contentDiv = document.getElementById("content-div");
            fetch("/api/products/", {headers: {"Authorization": userToken}})
                .then(response => {
                    contentDiv.style.display = "block";
                    contentDiv.innerHTML = "";
                    return response.json()
                })
                .then(data => {
                    if (!data) return;
                    let products = data.results;

                    //Формируем строку заголовка таблицы
                    let columnTitles = ["Номер", "Наименование", "Описание", "Цена", "Дата создания", "Дата изменения"];
                    let tableHeader = "";
                    for (let columnTitle of columnTitles) {
                        tableHeader += `<td>${columnTitle}</td>`;
                    }
                    tableHeader = `<tr>${tableHeader}</tr>`;

                    //Формируем тело таблицы
                    let tableData = "", tableRow = "", tableRows = "";
                    let dataKeys = ["id", "title", "description", "price", "dt_created", "dt_updated"];
                    for (let product of products) {
                        for (let key of dataKeys) {
                            tableRow += `<td>${product[key] ? product[key] : "- нет -"}</td>`
                        }
                        tableRows += `<tr>${tableRow}</tr>`;
                        tableRow = "";
                    }
                    tableData = `<table class="data-table">${tableHeader}${tableRows}</table>`;
                    contentDiv.innerHTML = tableData;
                })
        })
    </script>
{% endblock %}