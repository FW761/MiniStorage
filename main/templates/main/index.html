{% extends 'main/base_templat.html' %}

{% block menu %}
    <div id="header">
        <div class="basic-div">
            <ul id="menu">
                <li>
                <span>
                    {% if user.first_name or user.last_name %}
                        {{ user.get_full_name }}
                    {% else %}
                        {{ user }}
                    {% endif %}
                </span>
                    <ul>
                        <li>
                        <span>
                            <a href="{% url 'logout' %}">Выйти</a>
                        </span>
                        </li>
                    </ul>
                </li>
                <li>
                    <span>Справочники</span>
                    <ul>
                        <li>
                            <span id="show-products-button">Товары</span>
                        </li>
                        <li>
                            <span>Контрагенты</span>
                        </li>
                    </ul>
                </li>
                <li>
                    <span>Документы</span>
                    <ul>
                        <li>
                            <span>Приходные документы</span>
                        </li>
                        <li>
                            <span>Расходные документы</span>
                        </li>
                    </ul>
                </li>
                <li>
                    <span>Отчеты</span>
                    <ul>
                        <li>
                            <span>Остатки товаров на складе</span>
                        </li>
                        <li>
                            <span>Движение в разрезе товаров</span>
                        </li>
                        <li>
                            <span>Движение в разрезе контрагентов</span>
                        </li>
                    </ul>
                </li>
                <li>
                <span>
                    <a href="/admin/">Администрирование</a>
                </span>
                </li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block content %}
    <div class="basic-div content-div" id="content-div" style="display: none">
        <div class="operation-div">
            <a href="{% url 'products_to_xls' %}" class="anchor-button">Скачать в формате XLS</a>
            <span class="span-button" id="create-product-button">Создать</span>
            <input type="text" name="product-search-field" id="product-search-field" value="">
            <span class="span-button" id="search-product-button">Найти</span>
            <span class="span-button" id="clear-search-field-button">Очистить</span>
        </div>
    </div>
{% endblock %}

{% block modals %}
    <div class="modal" id="product-editor" style="display: none">
        <div>
            <div>
                <span class="span-button" id="product-editor-close-button">X</span>
            </div>
            <div>
                Номер: <span id="product-number"></span><br><br>
                Дата создания: <span id="product-dt-created"></span><br><br>
                Дата изменения <span id="product-dt-updated"></span><br><br>
                <form>
                    Цена: <br><input type="text" name="product-price" id="product-price" value="0" required><br><br>
                    Наименование:<br><input type="text" name="product-title" id="product-title" value=""
                                            required><br><br>
                    Описание:<br><textarea name="product-description" id="product-description"></textarea><br><br>
                    Пометить на удаление: <input type="checkbox" name="product-to-remove" id="product-to-remove">
                </form>
            </div>
            <br>
            <div>
                <span class="span-button" id="product-editor-cancel-button">Отмена</span>
                <span class="span-button" id="product-editor-save-button">Сохранить</span>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const apiProductsURL = "/api/products/";

        const userToken = localStorage.getItem("user_token");
        $.ajaxSetup({"headers": {"Authorization": userToken}});

        const $contentDiv = $("#content-div");
        const $productEditor = $("#product-editor");
        let currentContent = null;

        $("#show-products-button, #clear-search-field-button").click(() => {
            $("#product-search-field").val("");
            showProducts(apiProductsURL)
        });
        $("#create-product-button").click(productCreate);
        $("#search-product-button").click(productSearch);
        $("#product-editor-close-button, #product-editor-cancel-button").click(() => closeModal($productEditor));

        function createContentTable(data, columnTitles, columnKeys) {
            let $table = $("<table>", {"id": "content-table"}).addClass("content-table");

            //Формируем строку заголовка таблицы
            let $tableHeader = $("<tr>");
            for (let columnTitle of columnTitles) {
                $tableHeader.append($("<th>").text(columnTitle));
            }
            $table.append($tableHeader);

            //Формируем тело таблицы
            let value;
            for (let dataElement of data) {
                let $tableRow = $("<tr>").data("element", dataElement);
                for (let columnKey of columnKeys) {
                    if (typeof dataElement[columnKey] == "boolean") {
                        value = dataElement[columnKey] ? "X" : "-";
                    } else {
                        value = dataElement[columnKey];
                    }
                    $tableRow.append($("<td>").text(value));
                }
                $table.append($tableRow);
            }
            return $table;
        }

        function createNavigationDiv(nextPage, prevPage, showFunc) {
            if (nextPage || prevPage) {
                let $navigationDiv = $("<div>", {"class": "navigation-div"});
                if (prevPage) {
                    $navigationDiv.append(
                        $("<span>")
                            .addClass("span-button")
                            .text("Предыдущая страница")
                            .on("click", () => showFunc(prevPage))
                    )
                }
                if (nextPage) {
                    $navigationDiv.append(
                        $("<div>")
                            .addClass("span-button")
                            .text("Следующая страница")
                            .on("click", () => showFunc(nextPage))
                    )
                }
                return $navigationDiv;
            }
            return null;
        }

        function showModal($modal) {
            document.body.style.overflow = "hidden";
            $modal.css("display", "block");
        }

        function closeModal($modal) {
            document.body.style.overflow = "auto";
            $modal.css("display", "none");
        }

        function formatDates(obj) {
            //Приводим даты к более читаемому виду
            let dateExp = /(\d\d\d\d)-(\d\d)-(\d\d)T(\d\d:\d\d)/;
            if ("dt_created" in obj) {
                let [_, year, month, day, time] = dateExp.exec(obj.dt_created);
                obj.dt_created = `${day}.${month}.${year} ${time}`;
            }
            if ("dt_updated" in obj) {
                let [_, year, month, day, time] = dateExp.exec(obj.dt_updated);
                obj.dt_updated = `${day}.${month}.${year} ${time}`;
            }
            return obj;
        }

        function checkProductFormData() {
            //Проверяем корректность внесения данных
            if ($("#product-title").val().trim().length === 0) {
                throw new Error("Наименование не может быть пустым!");
            }
            if (!/^\d+$/.test($("#product-price").val())) {
                throw new Error("Поле цены заполнено некорректно!");
            }
        }

        function showProducts(url) {
            $.ajax(url, {
                "method": "GET",
                "dataType": "json",
                "success": function (data) {
                    $contentDiv.css("display", "block");
                    $(".content-table, .navigation-div").remove();

                    let products, nextPage, prevPage;
                    if ("results" in data) {
                        products = data.results;
                        nextPage = data.next;
                        prevPage = data.previous;
                    } else {
                        products = [data];
                        nextPage = prevPage = null;
                    }

                    //Приводим даты к более читаемому виду
                    for (let product of products) {
                        formatDates(product);
                    }
                    currentContent = products;

                    //Создаем таблицу со списком товаров
                    let columnTitles = ["Номер", "Наименование", "Описание", "Цена", "Дата создания", "Дата изменения", "Удл."];
                    let columnKeys = ["id", "title", "description", "price", "dt_created", "dt_updated", "to_remove"];
                    let $table = createContentTable(products, columnTitles, columnKeys);
                    $table.on("click", "tr", productEdit);
                    $contentDiv.append($table);

                    //Добавляем панель навигации для перехода по страницам
                    let $navigationDiv = createNavigationDiv(nextPage, prevPage, showProducts);
                    if ($navigationDiv) {
                        $contentDiv.append($navigationDiv);
                    }
                }
            })
        }

        function productEdit() {
            let selectedProduct = $.data(this, "element");
            if (!selectedProduct) return;

            let $row = $(this);

            showModal($productEditor);
            $("#product-number").text(selectedProduct.id);
            $("#product-dt-created").text(selectedProduct.dt_created);
            $("#product-dt-updated").text(selectedProduct.dt_updated);
            $("#product-title").val(selectedProduct.title);
            $("#product-description").text(selectedProduct.description);
            $("#product-price").val(selectedProduct.price);
            $("#product-to-remove").prop("checked", selectedProduct.to_remove);

            $("#product-editor-save-button").off().click(() => {
                //Проверяем корректность внесения данных в форму
                try {
                    checkProductFormData();
                } catch (error) {
                    alert(error.message);
                    return;
                }

                let urlForRequest = `${apiProductsURL}${selectedProduct.id}/`;
                $.ajax(urlForRequest, {
                    "method": "PATCH",
                    "dataType": "json",
                    "data": {
                        "title": $("#product-title").val(),
                        "description": $("#product-description").val(),
                        "price": $("#product-price").val(),
                        "to_remove": $("#product-to-remove:checked").val() ? true : false
                    },
                    "success": function (data) {
                        formatDates(data);

                        $row.empty();
                        $row.append($("<td>").text(data.id));
                        $row.append($("<td>").text(data.title));
                        $row.append($("<td>").text(data.description));
                        $row.append($("<td>").text(data.price));
                        $row.append($("<td>").text(data.dt_created));
                        $row.append($("<td>").text(data.dt_updated));
                        $row.append($("<td>").text(data.to_remove ? "X" : "-"));
                        $row.data("element", data);

                        closeModal($productEditor);
                    }
                })
            });
        }

        function productCreate() {
            showModal($productEditor);

            $("#product-number").text("-");
            $("#product-dt-created").text("-");
            $("#product-dt-updated").text("-");
            $("#product-title").val("");
            $("#product-description").text("");
            $("#product-price").val("0");
            $("#product-to-remove").prop("disabled", true);

            $("#product-editor-save-button").off().click(() => {
                try {
                    checkProductFormData();
                } catch (error) {
                    alert(error.message)
                    return;
                }

                $.ajax(apiProductsURL, {
                    "method": "POST",
                    "dataType": "json",
                    "data": {
                        "title": $("#product-title").val(),
                        "description": $("#product-description").val(),
                        "price": $("#product-price").val()
                    },
                    "success": function (data) {
                        closeModal($productEditor);
                        $("#product-search-field").val(data.id)
                        showProducts(`${apiProductsURL}${data.id}`);
                    }
                })
            })
        }

        function productSearch() {
            let searchString = $("#product-search-field").val();
            let urlForSearch = `${apiProductsURL}?search=${searchString}`;
            showProducts(urlForSearch);
        }
    </script>
{% endblock %}
