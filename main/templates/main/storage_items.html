{% extends 'main/index.html' %}
{% load static %}

{% block content %}
    <div class="basic-div content-div" id="content-div">

        <div class="operation-div">
            <input type="text" name="search-si-field" id="search-si-field" value="">
            <span class="span-button" id="search-si-button">Найти</span>
            <span class="span-button" id="clear-search-si-field-button">Очистить</span>
            <span class="span-button" id="show-si-append-div-button">+</span>
        </div>

        <div class="operation-div" id="si-append-div" style="display: none">
            <input type="text" name="search-p-field" id="search-p-field" value="">
            <span class="span-button" id="search-p-button">Найти</span>
            <span class="span-button" id="clear-search-p-field-button">Очистить</span>
        </div>

        <div class="search-result-div" id="search-p-result-div" style="display: none"></div>

        <table id="content-table" class="content-table">
            <tr>
                <th column-key="product" display-name="Номер">Номер</th>
                <th column-key="product_title" display-name="Наименование">Наименование</th>
                <th column-key="count" display-name="Количество">Количество</th>
            </tr>
        </table>
        <div class="navigation-div">
            <span class="span-button" id="prev-page-button">Предыдущая страница</span>
            <span class="span-button" id="next-page-button">Следующая страница</span>
        </div>
    </div>
{% endblock %}

{% block modals %}
    <div class="modal" id="si-editor" style="display: none">
        <div>
            <div>
                <span class="span-button" id="si-close-button">X</span>
            </div>
            <div>
                Номер: <span id="product-number"></span><br><br>
                Наименование: <span id="product-title"></span><br><br>
                <fieldset>
                    Количество: <input type="text" name="product-count" id="product-count" value="" required><br><br>
                    Пометить на удаление: <input type="checkbox" name="product-to-remove" id="product-to-remove">
                </fieldset>
            </div>
            <br>
            <div>
                <span class="span-button" id="si-cancel-button">Отмена</span>
                <span class="span-button" id="si-save-button">Сохранить</span>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const apiURL = "/api/storage_items/";
        const apiProductsURL = "/api/products/";

        function showStorageItems(url) {
            $.ajax(url, {
                "method": "GET",
                "dataType": "json",
                "success": function (data) {
                    let storageItems = data.results;
                    let nextPage = data.next;
                    let prevPage = data.previous;

                    //Создаем таблицу со списком контрагентов
                    let $contentTable = $("#content-table");
                    $("tr:not(:first-child)", $contentTable).remove()
                    let $tableRow = null;
                    for (let storageItem of storageItems) {
                        $tableRow = $("<tr>");
                        $tableRow.append($("<td>").text(storageItem.product));
                        $tableRow.append($("<td>").text(storageItem.product_title));
                        $tableRow.append($("<td>").text(storageItem.count));
                        $tableRow.data("storageItem", storageItem);
                        $contentTable.append($tableRow);
                    }
                    $contentTable.on("click", "tr:not(:first-child)", storageItemEdit);

                    let $prevPageButton = $("#prev-page-button");
                    if (prevPage) {
                        $prevPageButton.show();
                        $prevPageButton.off();
                        $prevPageButton.click(() => {
                            showStorageItems(prevPage);
                        })
                    } else {
                        $prevPageButton.hide();
                    }

                    let $nextPageButton = $("#next-page-button");
                    if (nextPage) {
                        $nextPageButton.show();
                        $nextPageButton.off();
                        $nextPageButton.click(() => {
                            showStorageItems(nextPage);
                        })
                    } else {
                        $nextPageButton.hide();
                    }
                },
                "error": function (jqXHR) {
                    showAjaxError(jqXHR, $("#contractor-editor"));
                }
            })
        }

        function storageItemEdit() {
            let selectedStorageItem = $(this).data("storageItem");

            let $row = $(this);

            showModal($("#si-editor"));
            $("#product-number").text(selectedStorageItem.product);
            $("#product-title").text(selectedStorageItem.product_title);
            $("#product-count").val(selectedStorageItem.count);
            //TODO Вставить код редактирования StorageItem
        }

        let storageItemsSearch = getSearchFunction(showStorageItems, $("#search-si-field"), apiURL);

        let storageItemSort = getSortFunction(showStorageItems, $("#search-si-field"), apiURL);

        let downloadProductsList = getDownloadListFunction($("#search-p-result-div"));

        let scrollProductsList = getScrollListFunction(downloadProductsList);

        //Обработчики для событий панели поиска StorageItem
        $("#search-si-button").click(() => {
            storageItemsSearch();
            $("#search-p-result-div").hide();
        });
        $("#clear-search-si-field-button").click(() => {
            $("#search-si-field").val("");
            storageItemsSearch();
            $("#search-p-result-div").hide();
        });
        $("#show-si-append-div-button").click(() => {
            let buttonText = $("#show-si-append-div-button").text();
            buttonText = buttonText === "-" ? "+" : "-";
            $("#show-si-append-div-button").text(buttonText);
            $("#si-append-div").slideToggle("normal");
            $("#search-p-result-div").hide();
        });

        //Обработчики событий панели добавления остатков
        $("#search-p-button").click(() => {
            let searchString = $("#search-p-field").val();
            if (!searchString) {
                return;
            }

            let $resultDiv = $("#search-p-result-div");
            $resultDiv.empty();
            $resultDiv.slideDown("normal");

            downloadProductsList(`${apiProductsURL}?search=${searchString}`);
        });
        $("#search-p-result-div").scroll(scrollProductsList);
        $("#clear-search-p-field-button").click(() => {
            $("#search-p-field").val("");
            $("#search-p-result-div").slideUp("normal");
        });
        $("#search-p-result-div").click((event) => {
            let product = $(event.target).data("element")
            //TODO Вставить код создания StorageItem
        });

        //Обработчик события клика по заголовку столбца (сортировка)
        $("#content-table th").click(storageItemSort);

        //Обработчики событий модального окна
        $("#si-close-button, #si-cancel-button").click(() => closeModal($("#si-editor")));

        showStorageItems(apiURL);
    </script>
{% endblock %}